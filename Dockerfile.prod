# Node.js 18 ê¸°ë°˜ ì´ë¯¸ì§€
FROM node:18-alpine

# Prisma ì‹¤í–‰ì„ ìœ„í•œ ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apk add --no-cache openssl libc6-compat

# ìž‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# backend í´ë”ë¡œ ì´ë™
WORKDIR /app/backend

# backend/package.jsonê³¼ tsconfig.json ë“± ë³µì‚¬
COPY ./backend/package*.json ./
COPY ./backend/tsconfig.json ./

# ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm ci && npm cache clean --force

# backend ì „ì²´ ë³µì‚¬
COPY backend/ .

# ë¹„ê¶Œí•œ ì‚¬ìš©ìž ì „í™˜
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /app

USER nodejs

# node_modules ë””ë ‰í† ë¦¬ ì†Œìœ ê¶Œ ëª…ì‹œì  ì„¤ì •
RUN chown -R nodejs:nodejs /app/backend/node_modules

# Prisma Client ìƒì„± (ì‚¬ìš©ìž ì „í™˜ í›„)
RUN npx prisma generate

# TypeScript ë¹Œë“œ
RUN npm run build

# í¬íŠ¸ ì„¤ì •
EXPOSE 3350

# ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'set -e' >> /app/start.sh && \
    echo 'cd /app/backend' >> /app/start.sh && \
    echo 'echo "ðŸš€ í´ë¼ìš°ë“œíƒ€ìž… í”„ë¡œë•ì…˜ ë°ì´í„° ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹œìž‘..."' >> /app/start.sh && \
    echo 'export DATABASE_URL="postgresql://root:tarscase12%21%40@svc.sel5.cloudtype.app:31473/main"' >> /app/start.sh && \
    echo 'echo "â³ í´ë¼ìš°ë“œíƒ€ìž… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘..."' >> /app/start.sh && \
    echo 'for i in $(seq 1 30); do' >> /app/start.sh && \
    echo '  if echo "SELECT 1" | npx prisma db execute --stdin > /dev/null 2>&1; then' >> /app/start.sh && \
    echo '    echo "âœ… í´ë¼ìš°ë“œíƒ€ìž… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ!"' >> /app/start.sh && \
    echo '    break' >> /app/start.sh && \
    echo '  fi' >> /app/start.sh && \
    echo '  echo "   ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘... ($i/30)"' >> /app/start.sh && \
    echo '  sleep 2' >> /app/start.sh && \
    echo 'done' >> /app/start.sh && \
    echo 'if ! echo "SELECT 1" | npx prisma db execute --stdin > /dev/null 2>&1; then' >> /app/start.sh && \
    echo '  echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."' >> /app/start.sh && \
    echo '  exit 1' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo 'echo "ðŸ”„ Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘..."' >> /app/start.sh && \
    echo 'npx prisma db push' >> /app/start.sh && \
    echo 'echo "ðŸ”§ Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì¤‘..."' >> /app/start.sh && \
    echo 'npx prisma generate' >> /app/start.sh && \
    echo 'echo "ðŸŽ‰ í´ë¼ìš°ë“œíƒ€ìž… í”„ë¡œë•ì…˜ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ!"' >> /app/start.sh && \
    echo 'echo "ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ì¤‘..."' >> /app/start.sh && \
    echo 'exec "$@"' >> /app/start.sh && \
    chmod +x /app/start.sh

# CMD ì‹¤í–‰
CMD ["/app/start.sh", "npm", "run", "start"]
